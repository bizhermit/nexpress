"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const next_1=__importDefault(require("next")),express_1=__importDefault(require("express")),express_session_1=__importDefault(require("express-session")),helmet_1=__importDefault(require("helmet")),path_1=__importDefault(require("path")),string_utils_1=__importDefault(require("@bizhermit/basic-utils/dist/string-utils")),datetime_utils_1=__importDefault(require("@bizhermit/basic-utils/dist/datetime-utils")),execute=e=>{const t=null!=process.argv.find((e=>"-dev"===e||"-d"===e));log(getDatetime()),log("::: @bizhermit/nexpress :::"+(t?" [dev]":"")),log("# props"),log(e);const s=e?.rootDirname??path_1.default.join(__dirname,"../../../../"),i=(0,next_1.default)({dev:t,dir:path_1.default.join(s,"src")}),r=i.getRequestHandler(),o=(t?e?.dev?.port:e?.port)??3e3;i.prepare().then((async()=>{const i=(0,express_1.default)();log("# i18n");const a=e?.i18nFilename??path_1.default.join(s,"src/i18n");try{global._language=(await Promise.resolve().then((()=>__importStar(require(a)))))?.default??{},log(a)}catch{global._language={},log(`Cannot find module: ${a}`)}i.use((0,express_session_1.default)({name:t?e?.dev?.session?.name:e?.session?.name,secret:(t?e?.dev?.session?.secret:e?.session?.secret)??string_utils_1.default.generateUuidV4(),resave:!1,saveUninitialized:!0,store:t?null==e?.dev?.session?.store?void 0:e.dev.session.store(sessionStorage):null==e?.session?.store?void 0:e.session.store(sessionStorage),cookie:{httpOnly:e?.dev?.session?.cookie?.httpOnly??!0,secure:!t,maxAge:(t?e?.dev?.session?.cookie?.maxAge:e?.session?.cookie?.maxAge)??18e5}})),t||i.set("trust proxy",1),i.use((0,helmet_1.default)({contentSecurityPolicy:!t,hidePoweredBy:!0,hsts:!0,frameguard:!0,xssFilter:!0})),i.disable("x-powered-by"),i.use(express_1.default.static(e?.publicDir??path_1.default.join(s,"src/public"))),i.all("*",((e,t)=>r(e,t))),log("# listen"),i.listen(o,(()=>{log(`start: localhost:${o}`),log(getDatetime())}))}))};exports.default=execute;const log=(e,...t)=>{console.log(e,...t)},getDatetime=()=>datetime_utils_1.default.format(new Date,"yyyy-MM-dd hh:mm:ss.SSS");